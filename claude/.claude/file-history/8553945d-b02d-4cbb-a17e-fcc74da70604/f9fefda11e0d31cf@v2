#!/usr/bin/env bash

# Load configuration file if it exists
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/tmux-sessionizer.conf"

if [[ -f $CONFIG_FILE ]]; then
    source $CONFIG_FILE
else
    # Default values if config file doesn't exist
    WINDOW_1_NAME="claude"
    WINDOW_1_COMMAND="claude"
    WINDOW_2_NAME="vim"
    WINDOW_2_COMMAND="vim ."
    WINDOW_3_NAME="terminal"
    WINDOW_3_COMMAND=""
    DEFAULT_WINDOW=1
fi

setup_default_windows() {
    local session_name=$1
    local project_path=$2

    # Setup first window
    tmux rename-window -t $session_name:1 "$WINDOW_1_NAME"
    if [[ -n $WINDOW_1_COMMAND ]]; then
        tmux send-keys -t $session_name:1 "$WINDOW_1_COMMAND" C-m
    fi

    # Create second window
    tmux new-window -t $session_name:2 -n "$WINDOW_2_NAME" -c $project_path
    if [[ -n $WINDOW_2_COMMAND ]]; then
        tmux send-keys -t $session_name:2 "$WINDOW_2_COMMAND" C-m
    fi

    # Create third window
    tmux new-window -t $session_name:3 -n "$WINDOW_3_NAME" -c $project_path
    if [[ -n $WINDOW_3_COMMAND ]]; then
        tmux send-keys -t $session_name:3 "$WINDOW_3_COMMAND" C-m
    fi

    # Select the default window
    tmux select-window -t $session_name:$DEFAULT_WINDOW
}

if [[ $# -eq 1 ]]; then
    selected=$1
else
    selected=$(find ~ ~/Documents/B_Product_Development ~/Documents/B_Product_Development/golang/alexander-grieco ~/Nextcloud/Development ~/Nextcloud/Development/golang/alexander-grieco ~/dapper -mindepth 1 -maxdepth 1 -type d | fzf)
fi

if [[ -z $selected ]]; then
    exit 0
fi

selected_name=$(basename "$selected" | tr . _)
tmux_running=$(pgrep tmux)

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
    tmux new-session -s $selected_name -c $selected -d
    setup_default_windows $selected_name $selected
    tmux attach-session -t $selected_name
    exit 0
fi

if ! tmux has-session -t=$selected_name 2> /dev/null; then
    tmux new-session -ds $selected_name -c $selected
    setup_default_windows $selected_name $selected
fi

if [[ -z $TMUX ]]; then
    tmux attach-session -t $selected_name
else
    tmux switch-client -t $selected_name
fi
